<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META NAME="generator" CONTENT="http://txt2tags.sf.net">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<TITLE>Mise en route de la lecture TéléInfo Historique sur Raspberry Pi 3</TITLE>
</HEAD><BODY BGCOLOR="white" TEXT="black">
<P ALIGN="center"><CENTER><H1>Mise en route de la lecture TéléInfo Historique sur Raspberry Pi 3</H1>
<FONT SIZE="4">
<I>Francis Micheli</I><BR>
2017-05-14
</FONT></CENTER>

<H1>Démodulateur</H1>
<P>
Basé sur un LTV-814 (0.22€ au lieu de 0.60€).
Pull-up de 10kΩ entre le 3.3V et l'optocoupleur.
</P>
<P>
Le LTV-814 a des temps de transition de 20µs au lieu de 4µs pour le SFH-620. À 1200 baud la durée d'un bit est de 833µs. À 9600 baud la durée d'un bit est de 104µs. Devrait marcher encore, même si le signal à l'air bien arrondi. En cas de problème diminier le  pull-up.
</P>
<H1>Activation de l'UART sur les broches 8 at 10 du GPIO</H1>
<P>
Sources :
</P>
<UL>
<LI><A HREF="http://www.framboise314.fr/le-port-serie-du-raspberry-pi-3-pas-simple/">http://www.framboise314.fr/le-port-serie-du-raspberry-pi-3-pas-simple/</A>
<LI><A HREF="http://www.journaldulapin.com/2016/02/25/raspberry-pi-teleinfo/">http://www.journaldulapin.com/2016/02/25/raspberry-pi-teleinfo/</A>
<LI><A HREF="http://www.magdiblog.fr/gpio/teleinfo-edf-suivi-conso-de-votre-compteur-electrique/">http://www.magdiblog.fr/gpio/teleinfo-edf-suivi-conso-de-votre-compteur-electrique/</A>
<LI><A HREF="http://spellfoundry.com/2016/05/29/configuring-gpio-serial-port-raspbian-jessie-including-pi-3/">http://spellfoundry.com/2016/05/29/configuring-gpio-serial-port-raspbian-jessie-including-pi-3/</A>
<LI>Et moi même...
</UL>

<H2>Modification du fichier /boot/config.txt</H2>
<P>
La fin du fichier se présente ainsi :
</P>
<PRE>
  # Serial GPIO is needed
  enable_uart=1
  # disable bluetooth and reuse the real UART
  dtoverlay=pi3-disable-bt
  #dtoverlay=pi3-miniuart-bt
</PRE>
<P></P>
<H2>Modification du fichier /boot/cmdline.txt</H2>
<P>
Supprimer "console=serial0,115200"
</P>
<P>
dwc_otg.lpm_enable=0 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait
</P>
<H2>Paramétrage du port série pour récupérer les trames</H2>
<P>
Mode 1200 7E1
</P>
<H3>Shell</H3>
<P>
A faire après chaque boot...
</P>
<P>
stty -F /dev/ttyAMA0 1200 cs7 evenp -cstopb -igncr -inlcr
</P>
<P>
Vérifier avec cat /dev/serial0 mais ne pas attendre de voir fidèlement tous les caractères des trames. Manque le mot d'état
</P>
<H3>Python3</H3>
<P>
Les &lt;cr&gt; &lt;lf&gt; &lt;stx&gt; &lt;etx&gt; sont passés tels quels. Le code suivant a bien fonctionné (trouvé sur internet et adapté à Python3).
</P>
<PRE>
  import sys
  import serial
  
  instream = serial.Serial(port="/dev/ttyAMA0", baudrate=1200, \
  bytesize=serial.SEVENBITS, parity=serial.PARITY_EVEN, \
  stopbits=serial.STOPBITS_ONE)
  
  while True :
      cc = instream.read(1)
      #print("&gt; {0} &lt;".format(cc))
      if cc == b'\x02' :
          sys.stdout.write("\n====== STX")
      elif cc == b'\x03' :
          sys.stdout.write("\n====== ETX")
      else :
          sys.stdout.write(cc.decode("ascii"))
</PRE>
<P></P>
<P>
Résultat dans la console :
</P>
<PRE>
  ====== STX
  ADCO 030422000048 .
  OPTARIF HC.. &lt;
  ISOUSC 30 9
  HCHC 036433204 _
  HCHP 039695921 ?
  PTEC HP..
  IINST 002 Y
  IMAX 031 C
  TENSION 245 ;
  PAPP 00410 &amp;
  HHPHC A ,
  MOTDETAT 000000 B
  ====== ETX
</PRE>
<P></P>

<!-- html code generated by txt2tags 2.5 (http://txt2tags.sf.net) -->
<!-- cmdline: txt2tags -q note.t2t -->
</BODY></HTML>
